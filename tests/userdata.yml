#cloud-config
# packages:
# - cuda-10-1
# - nvidia-container-toolkit
write_files:
  - content: |
      # BEGIN MANAGED BLOCK
      ETC = /etc/condor
      CONDOR_HOST = condor-cm.galaxyproject.eu
      ALLOW_WRITE = 10.5.68.0/24, 132.230.223.0/24
      ALLOW_READ = $(ALLOW_WRITE)
      ALLOW_ADMINISTRATOR = 10.5.68.0/24, 132.230.223.239
      ALLOW_NEGOTIATOR = $(ALLOW_ADMINISTRATOR)
      ALLOW_CONFIG = $(ALLOW_ADMINISTRATOR)
      ALLOW_DAEMON = $(ALLOW_ADMINISTRATOR)
      ALLOW_OWNER = $(ALLOW_ADMINISTRATOR)
      ALLOW_CLIENT = *
      DAEMON_LIST = MASTER, STARTD
      FILESYSTEM_DOMAIN = bi.uni-freiburg.de
      UID_DOMAIN = bi.uni-freiburg.de
      TRUST_UID_DOMAIN = True
      SOFT_UID_DOMAIN = True
      CLAIM_PARTITIONABLE_LEFTOVERS = True
      NUM_SLOTS = 1
      NUM_SLOTS_TYPE_1 = 1
      SLOT_TYPE_1 = 100%
      SLOT_TYPE_1_PARTITIONABLE = True
      ALLOW_PSLOT_PREEMPTION = False
      STARTD.PROPORTIONAL_SWAP_ASSIGNMENT = True
      MASTER_UPDATE_INTERVAL = 150
      UPDATE_INTERVAL = 120
      # END MANAGED BLOCK
      # Advertise the GPUs
      # use feature : GPUs
      # GPU_DISCOVERY_EXTRA = -extra
      GalaxyTraining = True
      GalaxyGroup = training-beta
      GalaxyCluster = none
      GalaxyDockerHack = False
      STARTD_ATTRS = GalaxyTraining, GalaxyGroup, GalaxyCluster, GalaxyDockerHack
      Rank = StringListMember(MY.GalaxyGroup, TARGET.Group)
      # BASE_CGROUP = /system.slice/condor.service
      # CGROUP_MEMORY_LIMIT_POLICY = soft
      # RESERVED_MEMORY = 4096
    owner: root:root
    path: /etc/condor/condor_config.local
    permissions: "0644"
  - content: |
      /data           /etc/auto.data          nfsvers=3
      /-              /etc/auto.usrlocal      nfsvers=3
    owner: root:root
    path: /etc/auto.master.d/data.autofs
    permissions: "0644"
  - content: |
      [[outputs.influxdb]]
        urls = ["https://influxdb.galaxyproject.eu:8086"]
        database = "galaxy"
        username = "galaxy"
        password = "mockup"
    owner: telegraf:telegraf
    path: /etc/telegraf/telegraf.d/output.conf
    permissions: "0640"
# BEGIN ANSIBLE MANAGED BLOCK
  - content: |
      db				-hard,rw,nosuid,nconnect=2			ufr-dyn.isi1.public.ads.uni-freiburg.de:/ifs/isi1/ufr/bronze/nfs/denbi/&
      dp01				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dataplant01
      0				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      1				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      2				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      3				-hard,rw,nosuid,nconnect=3			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      4				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      5				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      6				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      7				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/depot/&
      dnb-ds01				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01-legacy
      dnb-ds02				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb02-legacy
      dnb01				-hard,rw,nosuid,nconnect=2			ufr-dyn.isi1.public.ads.uni-freiburg.de:/ifs/isi1/ufr/bronze/nfs/denbi/&
      dnb02				-hard,rw,nosuid,nconnect=2			ufr-dyn.isi1.public.ads.uni-freiburg.de:/ifs/isi1/ufr/bronze/nfs/denbi/&
      dnb03				-hard,rw,nosuid,nconnect=2			ufr-dyn.isi1.public.ads.uni-freiburg.de:/ifs/isi1/ufr/bronze/nfs/denbi/&
      dnb04				-hard,rw,nosuid,nconnect=2			ufr-dyn.isi1.public.ads.uni-freiburg.de:/ifs/isi1/ufr/bronze/nfs/denbi/&
      dnb05				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb01/&
      dnb06				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb06
      dnb07				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb07
      dnb08				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/dnb08
      jwd				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/ws01/&
      jwd01				-hard,rw,nosuid			zfs1.galaxyproject.eu:/export/&
      jwd02f				-hard,rw,nosuid			zfs1.galaxyproject.eu:/export/&
      jwd03f				-hard,rw,nosuid,nconnect=2			denbi.svm.bwsfs.uni-freiburg.de:/ws02/&
      jwd04				-hard,rw,nosuid			zfs1.galaxyproject.eu:/export/&
      jwd05e				-hard,rw,nosuid			zfs1.galaxyproject.eu:/export/&
    owner: root:root
    path: /etc/auto.data
    permissions: "0644"
  - content: |
      /usr/local/tools						-hard,rw,nosuid,nconnect=2						denbi.svm.bwsfs.uni-freiburg.de:/dnb01/tools
      /opt/galaxy				-hard,rw,nosuid,nconnect=2				denbi.svm.bwsfs.uni-freiburg.de:/ws01/galaxy-sync/main/&
    owner: root:root
    path: /etc/auto.usrlocal
    permissions: "0644"
# END ANSIBLE MANAGED BLOCK
